#!/usr/bin/env bash

# Echo commands to stdout.
set -x

# Exit on first error.
set -e

# Treat undefined environment variables as errors.
set -u

# Remove the legacy nginx config, as it will conflict with tinypilot.conf if
# both are present.
if [ -f /etc/nginx/sites-enabled/KVMPi.conf ]; then
  sudo rm /etc/nginx/sites-enabled/KVMPi.conf
fi

pushd $(mktemp -d)
sudo apt-get install -y python3-venv
python3 -m venv venv
. venv/bin/activate
pip install ansible==2.9.10
ANSIBLE_ROLES_PATH="$PWD" ansible-playbook -i localhost, -c local /dev/stdin <<EOF
- hosts: localhost
  become: true
  pre_tasks:
    - name: Download roles with ansible-galaxy
      command: ansible-galaxy install mtlynch.tinypilot
  tasks:
    - include_role: name=mtlynch.tinypilot
EOF
